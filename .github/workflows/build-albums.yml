name: Build Album Packages

on:
  push:
    paths:
      - "**/*.mp3"
      - "**/*.m4a"
      - "**/README.md"
      - "**/LYRICS.txt"
      - "generate-catalog.py"
      - ".github/workflows/build-albums.yml"
  workflow_dispatch:

jobs:
  build-albums:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Convert MP3 to M4A
        run: |
          #!/bin/bash
          set -e

          echo "Checking for MP3 files that need M4A conversion..."
          conversions_made=false

          # Find all MP3 files (more specific pattern)
          while IFS= read -r mp3_file; do
            # Skip if file doesn't exist or is empty
            if [ ! -f "$mp3_file" ] || [ ! -s "$mp3_file" ]; then
              echo "Skipping invalid file: $mp3_file"
              continue
            fi
            
            # Verify it actually ends with .mp3 (case insensitive)
            if [[ ! "$mp3_file" =~ \.(mp3|MP3)$ ]]; then
              echo "Skipping non-MP3 file: $mp3_file"
              continue
            fi
            
            # Get directory and base name without extension (preserve original case)
            dir=$(dirname "$mp3_file")
            filename=$(basename "$mp3_file")
            base="${filename%.[mM][pP]3}"
            m4a_file="$dir/$base.m4a"

            # Check if M4A already exists
            if [ ! -f "$m4a_file" ]; then
              echo "Converting: $mp3_file -> $m4a_file"
              ffmpeg -nostdin -i "$mp3_file" -vn -map_metadata -1 -metadata artist="Carl Lance" -metadata comment="https://kepello.github.io/Musicplayer/" -c:a aac -b:a 256k -movflags +faststart "$m4a_file" 2>&1 | grep -v "^frame="
              conversions_made=true
            else
              echo "M4A already exists: $m4a_file"
            fi
          done < <(find . -type f \( -name "*.mp3" -o -name "*.MP3" \) ! -path "*/.*")

          if [ "$conversions_made" = true ]; then
            echo "Conversions completed. New M4A files will be committed."
          else
            echo "No conversions needed."
          fi

      - name: Clean metadata on all audio files
        run: |
          #!/bin/bash
          set -e

          echo "Cleaning metadata on all audio files..."

          # Process all MP3 files
          while IFS= read -r mp3_file; do
            if [ ! -f "$mp3_file" ] || [ ! -s "$mp3_file" ]; then
              continue
            fi
            
            echo "Cleaning metadata: $mp3_file"
            temp_file="${mp3_file}.tmp"
            ffmpeg -nostdin -i "$mp3_file" -map 0:a -map_metadata -1 -metadata artist="Carl Lance" -metadata comment="https://kepello.github.io/Musicplayer/" -c:a copy -f mp3 "$temp_file" 2>&1 | grep -v "^frame=" || true
            
            if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
              mv "$temp_file" "$mp3_file"
            else
              rm -f "$temp_file"
              echo "Failed to clean: $mp3_file"
            fi
          done < <(find . -type f \( -name "*.mp3" -o -name "*.MP3" \) ! -path "*/.*")

          # Process all M4A files
          while IFS= read -r m4a_file; do
            if [ ! -f "$m4a_file" ] || [ ! -s "$m4a_file" ]; then
              continue
            fi
            
            echo "Cleaning metadata: $m4a_file"
            temp_file="${m4a_file}.tmp"
            ffmpeg -nostdin -i "$m4a_file" -map_metadata -1 -metadata artist="Carl Lance" -metadata comment="https://kepello.github.io/Musicplayer/" -c:a copy -f ipod -movflags +faststart "$temp_file" 2>&1 | grep -v "^frame=" || true
            
            if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
              mv "$temp_file" "$m4a_file"
            else
              rm -f "$temp_file"
              echo "Failed to clean: $m4a_file"
            fi
          done < <(find . -type f -name "*.m4a" ! -path "*/.*")

          echo "Metadata cleaning completed."

      - name: Build collection packages
        run: |
          #!/bin/bash
          set -e

          # Get repo info for URLs
          GITHUB_REPO="${GITHUB_REPOSITORY:-owner/repo}"

          # Process each collection
          for collection_dir in */; do
            collection=$(basename "$collection_dir")
            
            # Skip special directories
            if [[ "$collection" == "node_modules" ]] || [[ "$collection" == ".git" ]] || [[ "$collection" == ".github" ]] || [[ "$collection" == ".venv" ]]; then
              continue
            fi
            
            echo "Processing collection: $collection"
            
            # Create temp directories for ZIP packages
            temp_dir=$(mktemp -d)
            m4a_collection_dir="$temp_dir/${collection}-M4A/$collection"
            mp3_collection_dir="$temp_dir/${collection}-MP3/$collection"
            mkdir -p "$m4a_collection_dir"
            mkdir -p "$mp3_collection_dir"
            
            # Create collection playlists
            collection_m4a_playlist="$collection_dir/${collection}-M4A.m3u8"
            collection_mp3_playlist="$collection_dir/${collection}-MP3.m3u8"
            
            echo "#EXTM3U" > "$collection_m4a_playlist"
            echo "#EXTENC:UTF-8" >> "$collection_m4a_playlist"
            
            echo "#EXTM3U" > "$collection_mp3_playlist"
            echo "#EXTENC:UTF-8" >> "$collection_mp3_playlist"
            
            # Track counts
            m4a_count=0
            mp3_count=0
            track_num=1
            
            # Process each song/album in the collection
            for song_dir in "$collection_dir"*/; do
              if [ ! -d "$song_dir" ]; then
                continue
              fi
              
              song=$(basename "$song_dir")
              
              # Find audio files
              m4a_file=$(find "$song_dir" -maxdepth 1 -type f -name "*.m4a" | head -n 1)
              mp3_file=$(find "$song_dir" -maxdepth 1 -type f -name "*.mp3" | head -n 1)
              
              padded_num=$(printf "%02d" $track_num)
              
              # Copy M4A if available
              if [ -n "$m4a_file" ] && [ -s "$m4a_file" ]; then
                output_name="${padded_num} - ${song}.m4a"
                cp "$m4a_file" "$m4a_collection_dir/$output_name"
                m4a_count=$((m4a_count + 1))
                
                # Add to playlist with URL
                m4a_relative_path="${m4a_file#./}"
                m4a_url="https://raw.githubusercontent.com/$GITHUB_REPO/main/$m4a_relative_path"
                echo "#EXTINF:-1,$song" >> "$collection_m4a_playlist"
                echo "$m4a_url" >> "$collection_m4a_playlist"
              fi
              
              # Copy MP3 if available
              if [ -n "$mp3_file" ] && [ -s "$mp3_file" ]; then
                output_name="${padded_num} - ${song}.mp3"
                cp "$mp3_file" "$mp3_collection_dir/$output_name"
                mp3_count=$((mp3_count + 1))
                
                # Add to playlist with URL
                mp3_relative_path="${mp3_file#./}"
                mp3_url="https://raw.githubusercontent.com/$GITHUB_REPO/main/$mp3_relative_path"
                echo "#EXTINF:-1,$song" >> "$collection_mp3_playlist"
                echo "$mp3_url" >> "$collection_mp3_playlist"
              fi
              
              track_num=$((track_num + 1))
            done
            
            # Create ZIP files only if we have multiple tracks (collections)
            if [ $m4a_count -gt 1 ]; then
              output_zip="$collection_dir/${collection}-M4A.zip"
              (cd "$temp_dir/${collection}-M4A" && zip -r - "$collection") > "$output_zip"
              echo "Created: $output_zip ($m4a_count tracks, $(du -h "$output_zip" | cut -f1))"
            else
              rm -f "$collection_m4a_playlist"
            fi
            
            if [ $mp3_count -gt 1 ]; then
              output_zip="$collection_dir/${collection}-MP3.zip"
              (cd "$temp_dir/${collection}-MP3" && zip -r - "$collection") > "$output_zip"
              echo "Created: $output_zip ($mp3_count tracks, $(du -h "$output_zip" | cut -f1))"
            else
              rm -f "$collection_mp3_playlist"
            fi
            
            # Cleanup
            rm -rf "$temp_dir"
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate catalog.json
        run: |
          echo "Generating catalog.json..."
          python generate-catalog.py
          echo "Catalog generation completed!"

      - name: Commit album packages and conversions
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add files if they exist (using find to avoid pathspec errors)
          find . -name "*.zip" -o -name "*.m3u8" -o -name "*.m4a" | grep -v ".git" | xargs -r git add

          # Add catalog.json if it exists
          [ -f catalog.json ] && git add catalog.json || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate album packages, catalog, and M4A conversions [skip ci]"
            git push
          fi
